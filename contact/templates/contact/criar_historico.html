{% extends 'global/base.html' %}

{% block title %}{% if created %}Criar{% else %}Editar{% endif %} Hist√≥rico - Ciclo {{ numero_ciclo }}{% endblock %}

{% block content %}
<div class="container-fluid py-4">
    <!-- Header -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card border-0 shadow-sm" style="border-radius: 15px; background: linear-gradient(135deg, {% if created %}#28a745{% else %}#ffc107{% endif %} 0%, {% if created %}#20c997{% else %}#fd7e14{% endif %} 100%);">
                <div class="card-body text-white text-center py-4">
                    <h2 class="mb-2">
                        {% if created %}
                            ‚ûï Criar Hist√≥rico - Ciclo {{ numero_ciclo }}
                        {% else %}
                            ‚úèÔ∏è Editar Hist√≥rico - Ciclo {{ numero_ciclo }}
                        {% endif %}
                    </h2>
                    <p class="mb-0 opacity-75">{{ inicio_ciclo|date:"d/m/Y" }} - {{ fim_ciclo|date:"d/m/Y" }}</p>
                </div>
            </div>
        </div>
    </div>

    <form method="post" id="formHistorico">
        {% csrf_token %}
        
        <div class="row">
            <!-- Atividades Comunit√°rias -->
            <div class="col-md-6 mb-4">
                <div class="card border-0 shadow-sm h-100" style="border-radius: 12px;">
                    <div class="card-header bg-primary text-white" style="border-radius: 12px 12px 0 0;">
                        <h5 class="mb-0">üèõÔ∏è Atividades Comunit√°rias</h5>
                        <small class="opacity-75">N√∫mero de atividades no final do ciclo</small>
                    </div>
                    <div class="card-body">
                        <!-- C√≠rculos de Estudo -->
                        <div class="mb-3">
                            <label class="form-label fw-bold">
                                <i class="fas fa-book text-info"></i> C√≠rculos de Estudo
                            </label>
                            <input type="number" name="total_circulos_estudo" 
                                   value="{{ historico.total_circulos_estudo }}" 
                                   class="form-control atividade-input" min="0" onchange="calcularTotais()">
                        </div>

                        <!-- Grupos de Pr√©-jovens -->
                        <div class="mb-3">
                            <label class="form-label fw-bold">
                                <i class="fas fa-users text-warning"></i> Grupos de Pr√©-jovens
                            </label>
                            <input type="number" name="total_grupos_prejovens" 
                                   value="{{ historico.total_grupos_prejovens }}" 
                                   class="form-control atividade-input" min="0" onchange="calcularTotais()">
                        </div>

                        <!-- Aulas de Crian√ßas -->
                        <div class="mb-3">
                            <label class="form-label fw-bold">
                                <i class="fas fa-child text-success"></i> Aulas de Crian√ßas
                            </label>
                            <input type="number" name="total_aulas_criancas" 
                                   value="{{ historico.total_aulas_criancas }}" 
                                   class="form-control atividade-input" min="0" onchange="calcularTotais()">
                        </div>

                        <!-- Reuni√µes Devocionais -->
                        <div class="mb-3">
                            <label class="form-label fw-bold">
                                <i class="fas fa-praying-hands text-secondary"></i> Reuni√µes Devocionais
                            </label>
                            <input type="number" name="total_reunioes_devocionais" 
                                   value="{{ historico.total_reunioes_devocionais }}" 
                                   class="form-control atividade-input" min="0" onchange="calcularTotais()">
                        </div>

                        <!-- Grupos de Fam√≠lias -->
                        <div class="mb-3">
                            <label class="form-label fw-bold">
                                <i class="fas fa-home text-primary"></i> Grupos de Fam√≠lias
                            </label>
                            <input type="number" name="total_grupos_familias" 
                                   value="{{ historico.total_grupos_familias }}" 
                                   class="form-control atividade-input" min="0" onchange="calcularTotais()">
                        </div>

                        <!-- Total de Atividades -->
                        <div class="alert alert-primary mt-3">
                            <strong>Total de Atividades: <span id="totalAtividades">0</span></strong>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Participantes -->
            <div class="col-md-6 mb-4">
                <div class="card border-0 shadow-sm h-100" style="border-radius: 12px;">
                    <div class="card-header bg-success text-white" style="border-radius: 12px 12px 0 0;">
                        <h5 class="mb-0">üë• Participantes</h5>
                        <small class="opacity-75">N√∫mero de participantes no final do ciclo</small>
                    </div>
                    <div class="card-body">
                        <!-- Participantes C√≠rculos -->
                        <div class="mb-3">
                            <label class="form-label fw-bold">
                                <i class="fas fa-book text-info"></i> Participantes - C√≠rculos
                            </label>
                            <input type="number" name="participantes_circulos" 
                                   value="{{ historico.participantes_circulos }}" 
                                   class="form-control participante-input" min="0" onchange="calcularTotais()">
                        </div>

                        <!-- Participantes Pr√©-jovens -->
                        <div class="mb-3">
                            <label class="form-label fw-bold">
                                <i class="fas fa-users text-warning"></i> Participantes - Pr√©-jovens
                            </label>
                            <input type="number" name="participantes_prejovens" 
                                   value="{{ historico.participantes_prejovens }}" 
                                   class="form-control participante-input" min="0" onchange="calcularTotais()">
                        </div>

                        <!-- Participantes Crian√ßas -->
                        <div class="mb-3">
                            <label class="form-label fw-bold">
                                <i class="fas fa-child text-success"></i> Participantes - Crian√ßas
                            </label>
                            <input type="number" name="participantes_criancas" 
                                   value="{{ historico.participantes_criancas }}" 
                                   class="form-control participante-input" min="0" onchange="calcularTotais()">
                        </div>

                        <!-- Participantes Devocionais -->
                        <div class="mb-3">
                            <label class="form-label fw-bold">
                                <i class="fas fa-praying-hands text-secondary"></i> Participantes - Devocionais
                            </label>
                            <input type="number" name="participantes_devocionais" 
                                   value="{{ historico.participantes_devocionais }}" 
                                   class="form-control participante-input" min="0" onchange="calcularTotais()">
                        </div>

                        <!-- Participantes Fam√≠lias -->
                        <div class="mb-3">
                            <label class="form-label fw-bold">
                                <i class="fas fa-home text-primary"></i> Participantes - Fam√≠lias
                            </label>
                            <input type="number" name="participantes_grupos_familias" 
                                   value="{{ historico.participantes_grupos_familias }}" 
                                   class="form-control participante-input" min="0" onchange="calcularTotais()">
                        </div>

                        <!-- Total de Participantes -->
                        <div class="alert alert-success mt-3">
                            <strong>Total de Participantes: <span id="totalParticipantes">0</span></strong>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Participantes Bah√°'√≠s -->
        <div class="row mb-4">
            <div class="col-md-12">
                <div class="card border-0 shadow-sm" style="border-radius: 12px;">
                    <div class="card-header bg-warning text-dark" style="border-radius: 12px 12px 0 0;">
                        <h5 class="mb-0">üïØÔ∏è Participantes Bah√°'√≠s</h5>
                        <small class="opacity-75">N√∫mero de participantes bah√°'√≠s no final do ciclo</small>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <!-- Bah√°'√≠s C√≠rculos -->
                            <div class="col-md-6 mb-3">
                                <label class="form-label fw-bold">
                                    <i class="fas fa-book text-info"></i> Bah√°'√≠s - C√≠rculos de Estudo
                                </label>
                                <input type="number" name="participantes_circulos_bahais" 
                                       value="{{ historico.participantes_circulos_bahais }}" 
                                       class="form-control bahai-input" min="0" onchange="calcularTotaisBahais()">
                            </div>

                            <!-- Bah√°'√≠s Pr√©-jovens -->
                            <div class="col-md-6 mb-3">
                                <label class="form-label fw-bold">
                                    <i class="fas fa-users text-warning"></i> Bah√°'√≠s - Grupos de Pr√©-jovens
                                </label>
                                <input type="number" name="participantes_prejovens_bahais" 
                                       value="{{ historico.participantes_prejovens_bahais }}" 
                                       class="form-control bahai-input" min="0" onchange="calcularTotaisBahais()">
                            </div>

                            <!-- Bah√°'√≠s Crian√ßas -->
                            <div class="col-md-6 mb-3">
                                <label class="form-label fw-bold">
                                    <i class="fas fa-child text-success"></i> Bah√°'√≠s - Aulas de Crian√ßas
                                </label>
                                <input type="number" name="participantes_criancas_bahais" 
                                       value="{{ historico.participantes_criancas_bahais }}" 
                                       class="form-control bahai-input" min="0" onchange="calcularTotaisBahais()">
                            </div>

                            <!-- Bah√°'√≠s Devocionais -->
                            <div class="col-md-6 mb-3">
                                <label class="form-label fw-bold">
                                    <i class="fas fa-praying-hands text-secondary"></i> Bah√°'√≠s - Reuni√µes Devocionais
                                </label>
                                <input type="number" name="participantes_devocionais_bahais" 
                                       value="{{ historico.participantes_devocionais_bahais }}" 
                                       class="form-control bahai-input" min="0" onchange="calcularTotaisBahais()">
                            </div>

                            <!-- Bah√°'√≠s Fam√≠lias -->
                            <div class="col-md-6 mb-3">
                                <label class="form-label fw-bold">
                                    <i class="fas fa-home text-primary"></i> Bah√°'√≠s - Grupos de Fam√≠lias
                                </label>
                                <input type="number" name="participantes_grupos_familias_bahais" 
                                       value="{{ historico.participantes_grupos_familias_bahais }}" 
                                       class="form-control bahai-input" min="0" onchange="calcularTotaisBahais()">
                            </div>

                            <!-- Total de Bah√°'√≠s -->
                            <div class="col-md-6 mb-3">
                                <div class="alert alert-warning mt-3">
                                    <strong>üïØÔ∏è Total de Bah√°'√≠s: <span id="totalBahais">0</span></strong>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Dados de Livros -->
        <div class="row mb-4">
            <div class="col-md-12">
                <div class="card border-0 shadow-sm" style="border-radius: 12px;">
                    <div class="card-header bg-info text-white" style="border-radius: 12px 12px 0 0;">
                        <h5 class="mb-0">üìö Dados de Livros</h5>
                        <small class="opacity-75">Estat√≠sticas de estudos no final do ciclo</small>
                    </div>
                    <div class="card-body">
                        <!-- Totais Gerais -->
                        <div class="row mb-4">
                            <div class="col-md-4">
                                <label class="form-label fw-bold">
                                    <i class="fas fa-book-open text-primary"></i> Total de Livros/Estudos
                                </label>
                                <input type="number" name="total_livros" 
                                       value="{{ historico.total_livros }}" 
                                       class="form-control" min="0" onchange="calcularTotais()">
                                <small class="text-muted">Total geral de estudos registrados</small>
                            </div>
                            <div class="col-md-4">
                                <label class="form-label fw-bold">
                                    <i class="fas fa-play text-success"></i> Total - Livros Iniciados no Ciclo
                                </label>
                                <input type="number" name="livros_iniciados" 
                                       value="{{ historico.livros_iniciados }}" 
                                       class="form-control" min="0" readonly>
                                <small class="text-muted">Soma autom√°tica por categoria</small>
                            </div>
                            <div class="col-md-4">
                                <label class="form-label fw-bold">
                                    <i class="fas fa-check text-warning"></i> Total - Livros Conclu√≠dos no Ciclo
                                </label>
                                <input type="number" name="livros_concluidos" 
                                       value="{{ historico.livros_concluidos }}" 
                                       class="form-control" min="0" readonly>
                                <small class="text-muted">Soma autom√°tica por categoria</small>
                            </div>
                        </div>

                        <hr>

                        <!-- Detalhamento por Categoria -->
                        <h6 class="mb-3 text-info">üìä Detalhamento por Categoria</h6>
                        
                        <!-- Sequ√™ncia (Ruhi) -->
                        <div class="row mb-3">
                            <div class="col-md-3">
                                <strong class="text-primary">üìò Sequ√™ncia (Ruhi)</strong>
                                <button type="button" class="btn btn-sm btn-outline-primary ms-2" onclick="adicionarLivro('Sequ√™ncia')">
                                    <i class="fas fa-plus"></i> Livro
                                </button>
                            </div>
                            <div class="col-md-4">
                                <label class="form-label">Iniciados no Ciclo</label>
                                <input type="number" name="livros_sequencia_iniciados" 
                                       value="{{ historico.livros_sequencia_iniciados }}" 
                                       class="form-control livro-categoria-input" min="0" onchange="calcularTotaisLivros()" readonly>
                                <small class="text-muted">Soma autom√°tica dos livros espec√≠ficos</small>
                            </div>
                            <div class="col-md-4">
                                <label class="form-label">Conclu√≠dos no Ciclo</label>
                                <input type="number" name="livros_sequencia_concluidos" 
                                       value="{{ historico.livros_sequencia_concluidos }}" 
                                       class="form-control livro-categoria-input" min="0" onchange="calcularTotaisLivros()" readonly>
                                <small class="text-muted">Soma autom√°tica dos livros espec√≠ficos</small>
                            </div>
                            <div class="col-md-1">
                                <label class="form-label">&nbsp;</label>
                                <button type="button" class="btn btn-sm btn-outline-info" onclick="mostrarLivrosCategoria('Sequ√™ncia')">
                                    <i class="fas fa-list"></i>
                                </button>
                            </div>
                        </div>
                        <div id="livros-Sequ√™ncia" class="mb-3"></div>

                        <!-- ABC (Aulas de Crian√ßas) -->
                        <div class="row mb-3">
                            <div class="col-md-3">
                                <strong class="text-success">üé® ABC (Aulas de Crian√ßas)</strong>
                                <button type="button" class="btn btn-sm btn-outline-success ms-2" onclick="adicionarLivro('ABC')">
                                    <i class="fas fa-plus"></i> Livro
                                </button>
                            </div>
                            <div class="col-md-4">
                                <input type="number" name="livros_abc_iniciados" 
                                       value="{{ historico.livros_abc_iniciados }}" 
                                       class="form-control livro-categoria-input" min="0" onchange="calcularTotaisLivros()" readonly>
                                <small class="text-muted">Soma autom√°tica dos livros espec√≠ficos</small>
                            </div>
                            <div class="col-md-4">
                                <input type="number" name="livros_abc_concluidos" 
                                       value="{{ historico.livros_abc_concluidos }}" 
                                       class="form-control livro-categoria-input" min="0" onchange="calcularTotaisLivros()" readonly>
                                <small class="text-muted">Soma autom√°tica dos livros espec√≠ficos</small>
                            </div>
                            <div class="col-md-1">
                                <label class="form-label">&nbsp;</label>
                                <button type="button" class="btn btn-sm btn-outline-info" onclick="mostrarLivrosCategoria('ABC')">
                                    <i class="fas fa-list"></i>
                                </button>
                            </div>
                        </div>
                        <div id="livros-ABC" class="mb-3"></div>

                        <!-- Pr√©-jovens -->
                        <div class="row mb-3">
                            <div class="col-md-3">
                                <strong class="text-warning">üåü Pr√©-jovens</strong>
                                <button type="button" class="btn btn-sm btn-outline-warning ms-2" onclick="adicionarLivro('Pr√©-jovens')">
                                    <i class="fas fa-plus"></i> Livro
                                </button>
                            </div>
                            <div class="col-md-4">
                                <input type="number" name="livros_prejovens_iniciados" 
                                       value="{{ historico.livros_prejovens_iniciados }}" 
                                       class="form-control livro-categoria-input" min="0" onchange="calcularTotaisLivros()" readonly>
                                <small class="text-muted">Soma autom√°tica dos livros espec√≠ficos</small>
                            </div>
                            <div class="col-md-4">
                                <input type="number" name="livros_prejovens_concluidos" 
                                       value="{{ historico.livros_prejovens_concluidos }}" 
                                       class="form-control livro-categoria-input" min="0" onchange="calcularTotaisLivros()" readonly>
                                <small class="text-muted">Soma autom√°tica dos livros espec√≠ficos</small>
                            </div>
                            <div class="col-md-1">
                                <label class="form-label">&nbsp;</label>
                                <button type="button" class="btn btn-sm btn-outline-info" onclick="mostrarLivrosCategoria('Pr√©-jovens')">
                                    <i class="fas fa-list"></i>
                                </button>
                            </div>
                        </div>
                        <div id="livros-Pr√©-jovens" class="mb-3"></div>

                        <!-- Outros -->
                        <div class="row mb-3">
                            <div class="col-md-3">
                                <strong class="text-secondary">üìñ Outros</strong>
                                <button type="button" class="btn btn-sm btn-outline-secondary ms-2" onclick="adicionarLivro('Outros')">
                                    <i class="fas fa-plus"></i> Livro
                                </button>
                            </div>
                            <div class="col-md-4">
                                <input type="number" name="livros_outros_iniciados" 
                                       value="{{ historico.livros_outros_iniciados }}" 
                                       class="form-control livro-categoria-input" min="0" onchange="calcularTotaisLivros()" readonly>
                                <small class="text-muted">Soma autom√°tica dos livros espec√≠ficos</small>
                            </div>
                            <div class="col-md-4">
                                <input type="number" name="livros_outros_concluidos" 
                                       value="{{ historico.livros_outros_concluidos }}" 
                                       class="form-control livro-categoria-input" min="0" onchange="calcularTotaisLivros()" readonly>
                                <small class="text-muted">Soma autom√°tica dos livros espec√≠ficos</small>
                            </div>
                            <div class="col-md-1">
                                <label class="form-label">&nbsp;</label>
                                <button type="button" class="btn btn-sm btn-outline-info" onclick="mostrarLivrosCategoria('Outros')">
                                    <i class="fas fa-list"></i>
                                </button>
                            </div>
                        </div>
                        <div id="livros-Outros" class="mb-3"></div>

                        <!-- Resumo -->
                        <div class="alert alert-info mt-3">
                            <div class="row">
                                <div class="col-md-6">
                                    <strong>Total Iniciados: <span id="totalLivrosIniciados">0</span></strong>
                                </div>
                                <div class="col-md-6">
                                    <strong>Total Conclu√≠dos: <span id="totalLivrosConcluidos">0</span></strong>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Bot√µes de A√ß√£o -->
        <div class="row">
            <div class="col-12 text-center">
                <a href="{% url 'contact:gerenciar_historico' %}" class="btn btn-secondary me-3">
                    <i class="fas fa-arrow-left"></i> Voltar
                </a>
                <button type="submit" class="btn btn-{% if created %}success{% else %}warning{% endif %} btn-lg">
                    <i class="fas fa-{% if created %}plus{% else %}save{% endif %}"></i> 
                    {% if created %}Criar Hist√≥rico{% else %}Salvar Altera√ß√µes{% endif %}
                </button>
            </div>
        </div>
    </form>
</div>

<script>
function calcularTotais() {
    // Calcular total de atividades
    let totalAtividades = 0;
    document.querySelectorAll('.atividade-input').forEach(input => {
        totalAtividades += parseInt(input.value) || 0;
    });
    document.getElementById('totalAtividades').textContent = totalAtividades;
    
    // Calcular total de participantes
    let totalParticipantes = 0;
    document.querySelectorAll('.participante-input').forEach(input => {
        totalParticipantes += parseInt(input.value) || 0;
    });
    document.getElementById('totalParticipantes').textContent = totalParticipantes;
}

function calcularTotaisBahais() {
    // Calcular total de participantes bah√°'√≠s
    let totalBahais = 0;
    document.querySelectorAll('.bahai-input').forEach(input => {
        totalBahais += parseInt(input.value) || 0;
    });
    document.getElementById('totalBahais').textContent = totalBahais;
}

function calcularTotaisLivros() {
    // Calcular totais de livros por categoria
    let totalIniciados = 0;
    let totalConcluidos = 0;
    
    // Mapear nomes de categoria
    const categoriaMap = {
        'Sequ√™ncia': 'sequencia',
        'ABC': 'abc',
        'Pr√©-jovens': 'prejovens',
        'Outros': 'outros'
    };
    
    // Somar por categoria baseado nos livros espec√≠ficos
    ['Sequ√™ncia', 'ABC', 'Pr√©-jovens', 'Outros'].forEach(categoria => {
        let categoriaIniciados = 0;
        let categoriaConcluidos = 0;
        
        // Somar todos os livros espec√≠ficos desta categoria
        const container = document.getElementById(`livros-${categoria}`);
        if (container) {
            const inputs = container.querySelectorAll('input');
            inputs.forEach(input => {
                if (input.name.includes('_iniciados')) {
                    categoriaIniciados += parseInt(input.value) || 0;
                } else if (input.name.includes('_concluidos')) {
                    categoriaConcluidos += parseInt(input.value) || 0;
                }
            });
        }
        
        // Atualizar campos de categoria
        const categoriaBackend = categoriaMap[categoria] || categoria.toLowerCase();
        const inputIniciados = document.querySelector(`input[name="livros_${categoriaBackend}_iniciados"]`);
        const inputConcluidos = document.querySelector(`input[name="livros_${categoriaBackend}_concluidos"]`);
        
        if (inputIniciados) inputIniciados.value = categoriaIniciados;
        if (inputConcluidos) inputConcluidos.value = categoriaConcluidos;
        
        totalIniciados += categoriaIniciados;
        totalConcluidos += categoriaConcluidos;
    });
    
    // Atualizar campos totais
    document.querySelector('input[name="livros_iniciados"]').value = totalIniciados;
    document.querySelector('input[name="livros_concluidos"]').value = totalConcluidos;
    
    // Atualizar resumo visual
    document.getElementById('totalLivrosIniciados').textContent = totalIniciados;
    document.getElementById('totalLivrosConcluidos').textContent = totalConcluidos;
}

let contadorLivros = 0;

function adicionarLivro(categoria) {
    contadorLivros++;
    const container = document.getElementById(`livros-${categoria}`);
    
    // FOR√áAR MAPEAMENTO CORRETO
    let categoriaBackend;
    switch(categoria) {
        case 'Sequ√™ncia':
            categoriaBackend = 'sequencia';
            break;
        case 'ABC':
            categoriaBackend = 'abc';
            break;
        case 'Pr√©-jovens':
            categoriaBackend = 'prejovens';
            break;
        case 'Outros':
            categoriaBackend = 'outros';
            break;
        default:
            categoriaBackend = categoria.toLowerCase();
    }
    
    const livroDiv = document.createElement('div');
    livroDiv.className = 'row mb-2 align-items-center bg-light p-2 rounded';
    livroDiv.id = `livro-${categoria}-${contadorLivros}`;
    
    const nomeField = `livro_${categoriaBackend}_${contadorLivros}_nome`;
    
    livroDiv.innerHTML = `
        <div class="col-md-3">
            <input type="text" name="${nomeField}" 
                   class="form-control form-control-sm" placeholder="Ex: Livro 1, S√©rie 2" required>
        </div>
        <div class="col-md-3">
            <input type="number" name="livro_${categoriaBackend}_${contadorLivros}_iniciados" 
                   class="form-control form-control-sm" min="0" placeholder="Iniciados" onchange="calcularTotaisLivros()">
        </div>
        <div class="col-md-3">
            <input type="number" name="livro_${categoriaBackend}_${contadorLivros}_concluidos" 
                   class="form-control form-control-sm" min="0" placeholder="Conclu√≠dos" onchange="calcularTotaisLivros()">
        </div>
        <div class="col-md-2">
            <input type="text" name="livro_${categoriaBackend}_${contadorLivros}_observacoes" 
                   class="form-control form-control-sm" placeholder="Obs...">
        </div>
        <div class="col-md-1">
            <button type="button" class="btn btn-sm btn-outline-danger" onclick="removerLivro('livro-${categoria}-${contadorLivros}')">
                <i class="fas fa-trash"></i>
            </button>
        </div>
    `;
    
    container.appendChild(livroDiv);
    
    // Se √© o primeiro livro da categoria, mostrar header
    if (container.children.length === 1) {
        const headerDiv = document.createElement('div');
        headerDiv.className = 'row mb-2 fw-bold text-muted';
        headerDiv.innerHTML = `
            <div class="col-md-3">Nome do Livro</div>
            <div class="col-md-3">Iniciados</div>
            <div class="col-md-3">Conclu√≠dos</div>
            <div class="col-md-2">Observa√ß√µes</div>
            <div class="col-md-1">A√ß√£o</div>
        `;
        container.insertBefore(headerDiv, livroDiv);
    }
    
    calcularTotaisLivros();
}

function removerLivro(livroId) {
    const livro = document.getElementById(livroId);
    const container = livro.parentElement;
    livro.remove();
    
    // Se n√£o h√° mais livros, remover header tamb√©m
    if (container.children.length === 1) {
        container.firstElementChild.remove();
    }
    
    calcularTotaisLivros();
}

function mostrarLivrosCategoria(categoria) {
    const container = document.getElementById(`livros-${categoria}`);
    if (container.style.display === 'none' || container.style.display === '') {
        container.style.display = 'block';
    } else {
        container.style.display = 'none';
    }
}

// Calcular totais ao carregar a p√°gina
document.addEventListener('DOMContentLoaded', function() {
    calcularTotais();
    calcularTotaisBahais();
    calcularTotaisLivros();
});

// Valida√ß√£o do formul√°rio
document.getElementById('formHistorico').addEventListener('submit', function(e) {
    const totalAtividades = parseInt(document.getElementById('totalAtividades').textContent);
    const totalParticipantes = parseInt(document.getElementById('totalParticipantes').textContent);
    
    if (totalAtividades === 0 && totalParticipantes === 0) {
        e.preventDefault();
        alert('Por favor, preencha pelo menos um campo de atividades ou participantes.');
        return false;
    }
    
    return true;
});

// Teste de debug para verificar mapeamento
function testarMapeamento() {
    console.log('üß™ Testando mapeamento de categorias:');
    const categoriaMap = {
        'Sequ√™ncia': 'sequencia',
        'ABC': 'abc',
        'Pr√©-jovens': 'prejovens',
        'Outros': 'outros'
    };
    
    for (const [categoria, backend] of Object.entries(categoriaMap)) {
        console.log(`  "${categoria}" -> "${backend}"`);
        console.log(`  Campo seria: livro_${backend}_1_nome`);
    }
}

// Adicionar log antes do submit
document.addEventListener('DOMContentLoaded', function() {
    // Executar teste de mapeamento
    testarMapeamento();
    
    const form = document.querySelector('form');
    if (form) {
        form.addEventListener('submit', function(e) {
            console.log('üìã Campos do formul√°rio sendo enviados:');
            const formData = new FormData(form);
            for (let [key, value] of formData.entries()) {
                if (key.includes('livro_')) {
                    console.log(`  ${key}: "${value}"`);
                }
            }
        });
    }
    
    {% if livros_existentes %}
        {% for categoria, livros in livros_existentes.items %}
            {% for livro in livros %}
                adicionarLivroExistente('{{ categoria|title }}', '{{ livro.nome }}', {{ livro.iniciados }}, {{ livro.concluidos }}, '{{ livro.observacoes|default:"" }}');
            {% endfor %}
        {% endfor %}
    {% endif %}
    
    calcularTotaisLivros();
});

function adicionarLivroExistente(categoria, nome, iniciados, concluidos, observacoes) {
    contadorLivros++;
    const container = document.getElementById(`livros-${categoria}`);
    
    // Mapear nomes de categoria para lowercase usado no backend
    const categoriaMap = {
        'Sequ√™ncia': 'sequencia',
        'ABC': 'abc',
        'Pr√©-jovens': 'prejovens',
        'Outros': 'outros'
    };
    const categoriaBackend = categoriaMap[categoria] || categoria.toLowerCase();
    
    const livroDiv = document.createElement('div');
    livroDiv.className = 'row mb-2 align-items-center bg-light p-2 rounded';
    livroDiv.id = `livro-${categoria}-${contadorLivros}`;
    
    livroDiv.innerHTML = `
        <div class="col-md-3">
            <input type="text" name="livro_${categoriaBackend}_${contadorLivros}_nome" 
                   class="form-control form-control-sm" placeholder="Ex: Livro 1, S√©rie 2" value="${nome}" required>
        </div>
        <div class="col-md-3">
            <input type="number" name="livro_${categoriaBackend}_${contadorLivros}_iniciados" 
                   class="form-control form-control-sm" min="0" placeholder="Iniciados" value="${iniciados}" onchange="calcularTotaisLivros()">
        </div>
        <div class="col-md-3">
            <input type="number" name="livro_${categoriaBackend}_${contadorLivros}_concluidos" 
                   class="form-control form-control-sm" min="0" placeholder="Conclu√≠dos" value="${concluidos}" onchange="calcularTotaisLivros()">
        </div>
        <div class="col-md-2">
            <input type="text" name="livro_${categoriaBackend}_${contadorLivros}_observacoes" 
                   class="form-control form-control-sm" placeholder="Obs..." value="${observacoes}">
        </div>
        <div class="col-md-1">
            <button type="button" class="btn btn-sm btn-outline-danger" onclick="removerLivro('livro-${categoria}-${contadorLivros}')">
                <i class="fas fa-trash"></i>
            </button>
        </div>
    `;
    
    container.appendChild(livroDiv);
    
    // Se √© o primeiro livro da categoria, mostrar header
    if (container.children.length === 1) {
        const headerDiv = document.createElement('div');
        headerDiv.className = 'row mb-2 fw-bold text-muted';
        headerDiv.innerHTML = `
            <div class="col-md-3">Nome do Livro</div>
            <div class="col-md-3">Iniciados</div>
            <div class="col-md-3">Conclu√≠dos</div>
            <div class="col-md-2">Observa√ß√µes</div>
            <div class="col-md-1">A√ß√£o</div>
        `;
        container.insertBefore(headerDiv, livroDiv);
    }
}
</script>
{% endblock %}